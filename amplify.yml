version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Starting build process"
        - echo "Fetching secrets from AWS Secrets Manager"
        - aws secretsmanager get-secret-value --secret-id qmssecretnamedb --region eu-north-1 --query SecretString --output text > /tmp/secrets.json
        - echo "Secrets fetched successfully"
        - |
          DB_USER=$(cat /tmp/secrets.json | jq -r '.username')
          DB_PASS=$(cat /tmp/secrets.json | jq -r '.password' | jq -sRr '@uri')
          DB_HOST=$(cat /tmp/secrets.json | jq -r '.host')
          DB_PORT=$(cat /tmp/secrets.json | jq -r '.port')
          export DATABASE_URL="mysql://${DB_USER}:${DB_PASS}@${DB_HOST}:${DB_PORT}/qmstool"
          export JWT_SECRET=$(cat /tmp/secrets.json | jq -r '.JWT_SECRET')
          export NEXTAUTH_SECRET=$(cat /tmp/secrets.json | jq -r '.NEXTAUTH_SECRET')
          export NEXTAUTH_URL=$(cat /tmp/secrets.json | jq -r '.NEXTAUTH_URL')
          export OKTA_CLIENT_ID=$(cat /tmp/secrets.json | jq -r '.OKTA_CLIENT_ID')
          export OKTA_CLIENT_SECRET=$(cat /tmp/secrets.json | jq -r '.OKTA_CLIENT_SECRET')
          export OKTA_ISSUER=$(cat /tmp/secrets.json | jq -r '.OKTA_ISSUER')
          export S3_BUCKET_NAME=$(cat /tmp/secrets.json | jq -r '.S3_BUCKET_NAME')
          export REGION=$(cat /tmp/secrets.json | jq -r '.REGION')
          export ACCESS_KEY_ID=$(cat /tmp/secrets.json | jq -r '.ACCESS_KEY_ID')
          export SECRET_ACCESS_KEY=$(cat /tmp/secrets.json | jq -r '.SECRET_ACCESS_KEY')
        - echo "Secrets exported as environment variables"
        - rm /tmp/secrets.json
        - echo "Installing dependencies"
        - npm ci
        - echo "Setting up Prisma"
        - npx prisma --version
        - npx prisma generate
        - echo "Prisma client generated successfully"
    build:
      commands:
        - echo Building Next.js app...
        - npm run build
        - echo Build completed successfully
        - echo Checking build output...
        - ls -la .next/
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'
        - key: 'X-Frame-Options'
          value: 'DENY'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin'