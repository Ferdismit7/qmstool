version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Starting build process"
        - echo "Fetching secrets from AWS Secrets Manager for build-time use"
        - aws secretsmanager get-secret-value --secret-id qmssecretnamedb --region eu-north-1 --query SecretString --output text > /tmp/secrets.json
        - echo "Secrets fetched successfully"
        - node -e "const fs=require('fs');const s=JSON.parse(fs.readFileSync('/tmp/secrets.json','utf8'));const p=encodeURIComponent(s.password);const db='mysql://'+s.username+':'+p+'@'+s.host+':'+s.port+'/qmstool';fs.writeFileSync('.env.production.local','DATABASE_URL='+db+'\nJWT_SECRET='+s.JWT_SECRET+'\nNEXTAUTH_SECRET='+s.NEXTAUTH_SECRET+'\nNEXTAUTH_URL='+s.NEXTAUTH_URL+'\nOKTA_CLIENT_ID='+s.OKTA_CLIENT_ID+'\nOKTA_CLIENT_SECRET='+s.OKTA_CLIENT_SECRET+'\nOKTA_ISSUER='+s.OKTA_ISSUER+'\nS3_BUCKET_NAME='+s.S3_BUCKET_NAME+'\nREGION='+s.REGION+'\nACCESS_KEY_ID='+s.ACCESS_KEY_ID+'\nSECRET_ACCESS_KEY='+s.SECRET_ACCESS_KEY);console.log('Environment variables written');"
        - echo "Secrets configured for build and runtime"
        - rm /tmp/secrets.json
        - echo "Installing dependencies"
        - npm ci
        - echo "Setting up Prisma"
        - npx prisma --version
        - npx prisma generate
        - echo "Prisma client generated successfully"
    build:
      commands:
        - echo Building Next.js app...
        - npm run build
        - echo Build completed successfully
        - echo Checking build output...
        - ls -la .next/
        - echo Copying .env.production.local to standalone directory...
        - cp .env.production.local .next/standalone/.env.production.local 2>/dev/null || echo "Standalone directory not found, skipping copy"
        - echo Environment setup complete
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'
        - key: 'X-Frame-Options'
          value: 'DENY'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin'