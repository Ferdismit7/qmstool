version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Starting build process"
        - echo "Fetching secrets from AWS Secrets Manager"
        - aws secretsmanager get-secret-value --secret-id qmssecretnamedb --region eu-north-1 --query SecretString --output text > /tmp/secrets.json
        - echo "Secrets fetched successfully"
        - |
          node -e "
          const fs = require('fs');
          const secrets = JSON.parse(fs.readFileSync('/tmp/secrets.json', 'utf8'));
          const encodePassword = (pass) => encodeURIComponent(pass);
          const databaseUrl = \`mysql://\${secrets.username}:\${encodePassword(secrets.password)}@\${secrets.host}:\${secrets.port}/qmstool\`;
          
          console.log(\`export DATABASE_URL=\"\${databaseUrl}\"\`);
          console.log(\`export JWT_SECRET=\"\${secrets.JWT_SECRET}\"\`);
          console.log(\`export NEXTAUTH_SECRET=\"\${secrets.NEXTAUTH_SECRET}\"\`);
          console.log(\`export NEXTAUTH_URL=\"\${secrets.NEXTAUTH_URL}\"\`);
          console.log(\`export OKTA_CLIENT_ID=\"\${secrets.OKTA_CLIENT_ID}\"\`);
          console.log(\`export OKTA_CLIENT_SECRET=\"\${secrets.OKTA_CLIENT_SECRET}\"\`);
          console.log(\`export OKTA_ISSUER=\"\${secrets.OKTA_ISSUER}\"\`);
          console.log(\`export S3_BUCKET_NAME=\"\${secrets.S3_BUCKET_NAME}\"\`);
          console.log(\`export REGION=\"\${secrets.REGION}\"\`);
          console.log(\`export ACCESS_KEY_ID=\"\${secrets.ACCESS_KEY_ID}\"\`);
          console.log(\`export SECRET_ACCESS_KEY=\"\${secrets.SECRET_ACCESS_KEY}\"\`);
          " > /tmp/export_secrets.sh
        - source /tmp/export_secrets.sh
        - echo "Secrets exported as environment variables"
        - rm /tmp/secrets.json
        - echo "Installing dependencies"
        - npm ci
        - echo "Setting up Prisma"
        - npx prisma --version
        - npx prisma generate
        - echo "Prisma client generated successfully"
    build:
      commands:
        - echo Building Next.js app...
        - npm run build
        - echo Build completed successfully
        - echo Checking build output...
        - ls -la .next/
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'
        - key: 'X-Frame-Options'
          value: 'DENY'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin'