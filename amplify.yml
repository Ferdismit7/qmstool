version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Starting build process"
        - echo "Fetching secrets from AWS Secrets Manager for build-time use"
        - aws secretsmanager get-secret-value --secret-id qmssecretnamedb --region eu-north-1 --query SecretString --output text > /tmp/secrets.json
        - echo "Secrets fetched successfully"
        - node -e "const fs=require('fs');const encode=(value)=>{try{return encodeURIComponent(decodeURIComponent(value));}catch{return encodeURIComponent(value);}};const s=JSON.parse(fs.readFileSync('/tmp/secrets.json','utf8'));const db='mysql://'+s.username+':'+encode(s.password)+'@'+s.host+':'+s.port+'/qmstool';const envsh='export DATABASE_URL=\"'+db+'\"\nexport JWT_SECRET=\"'+s.JWT_SECRET+'\"\nexport S3_BUCKET_NAME=\"'+s.S3_BUCKET_NAME+'\"\nexport REGION=\"'+s.REGION+'\"\nexport ACCESS_KEY_ID=\"'+s.ACCESS_KEY_ID+'\"\nexport SECRET_ACCESS_KEY=\"'+s.SECRET_ACCESS_KEY+'\"';const envfile='DATABASE_URL='+db+'\nJWT_SECRET='+s.JWT_SECRET+'\nS3_BUCKET_NAME='+s.S3_BUCKET_NAME+'\nREGION='+s.REGION+'\nACCESS_KEY_ID='+s.ACCESS_KEY_ID+'\nSECRET_ACCESS_KEY='+s.SECRET_ACCESS_KEY;fs.writeFileSync('/tmp/export_env.sh',envsh);fs.writeFileSync('.env.production.local',envfile);console.log('Environment files created');"
        - source /tmp/export_env.sh
        - echo "Environment variables exported for build and runtime"
        - rm /tmp/secrets.json /tmp/export_env.sh
        - echo "Installing dependencies"
        - npm ci
        - echo "Setting up Prisma"
        - npx prisma --version
        - npx prisma generate
        - echo "Prisma client generated successfully"
    build:
      commands:
        - echo Building Next.js app with environment variables...
        - npm run build
        - echo Build completed successfully
        - echo Verifying environment variables are set...
        - echo "DATABASE_URL is set:" $(if [ -n "$DATABASE_URL" ]; then echo "YES"; else echo "NO"; fi)
        - echo "JWT_SECRET is set:" $(if [ -n "$JWT_SECRET" ]; then echo "YES"; else echo "NO"; fi)
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
      - '../.env.production.local'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'
        - key: 'X-Frame-Options'
          value: 'DENY'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin'